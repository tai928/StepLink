 <!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>StepLink Chatbot</title>

  <!-- StepLinkã®CSSã‚’ç›´èª­ã¿ -->
  <link rel="stylesheet" href="https://tai928.github.io/StepLink/style.css">

  <style>
    /* ã“ã®ãƒšãƒ¼ã‚¸ã ã‘ã®å¾®èª¿æ•´ï¼ˆStepLink CSSã‚’å£Šã•ãªã„æœ€å°é™ï¼‰ */
    .timeline { padding-bottom: 16px; }
    .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .toolbar select{
      padding: 8px 10px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
    }
    .toolbar .icon-btn { height: 36px; }
    .dm-messages { background: #f7f7f7; } /* CSSå†…ã«ã‚‚ã‚ã‚‹ã‘ã©å¿µæŠ¼ã— */
    .dm-thread { height: calc(100vh - 56px); } /* ãƒ˜ãƒƒãƒ€ãƒ¼åˆ† */
    @media (max-width: 900px){
      .dm-thread { height: calc(100vh - 56px - 56px); } /* ãƒœãƒˆãƒ ãƒŠãƒ“åˆ†ã‚‚ã–ã£ãã‚Š */
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆStepLinkã¨åŒã˜è¦‹ãŸç›®ï¼‰ -->
    <aside class="sidebar-left">
      <div class="logo">StepLink</div>

    <nav class="nav">
      <a href="index.html" class="nav-item">ãƒ›ãƒ¼ãƒ </a>
      <a href="messages.html" class="nav-item">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</a>
      <a href="notifications.html" class="nav-item notif-nav">
        <span class="notif-wrap">
          ğŸ””
          <span class="notif-dot" data-notif-dot></span>
        </span>
        é€šçŸ¥
      </a>
      <a href="profile.html" class="nav-item">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</a>
      <a href="AI.html" class="nav-item">AI</a>
    </nav>
     
      <button class="post-button" id="newThread">æ–°ã—ã„ä¼šè©±</button>

      <div class="account-summary">
        <div class="account-main">
          <div class="account-avatar">ğŸ™‚</div>
          <div>
            <div class="account-name">AI Chat</div>
            <div class="account-handle">@steplink</div>
          </div>
        </div>
      </div>
    </aside>

    <!-- ãƒ¡ã‚¤ãƒ³ -->
    <main class="timeline">
      <div class="timeline-header">
        <div class="toolbar">
          <strong>AI Chat</strong>

          <select id="mbti"></select>

          <select id="verbosity">
            <option value="short">çŸ­ã‚</option>
            <option value="normal" selected>æ™®é€š</option>
            <option value="long">è©³ã—ã‚</option>
          </select>

          <select id="mode">
            <option value="consult" selected>ç›¸è«‡</option>
            <option value="chat">é›‘è«‡</option>
          </select>

          <button class="icon-btn" id="clear">å±¥æ­´ã‚¯ãƒªã‚¢</button>
        </div>
      </div>

      <!-- DMã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’æµç”¨ -->
      <section class="dm-thread">
        <div id="chat" class="dm-messages"></div>

        <div class="dm-input-area">
          <textarea id="msg" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›â€¦"></textarea>
          <button id="send" class="dm-send-btn">é€ä¿¡</button>
        </div>
      </section>

    </main>
  </div>

<script type="module">
  import { MBTI_LIST, MBTI_POLICIES } from "./mbti_policies.js";
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "https://ngtthuwmqdcxgddlbsyo.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_YJzguO8nmmVKURa58cKwVw__9ulKxI6";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const chat = document.getElementById("chat");
  const msg = document.getElementById("msg");
  const sendBtn = document.getElementById("send");
  const newThreadBtn = document.getElementById("newThread");
  const clearBtn = document.getElementById("clear");

  const mbtiSel = document.getElementById("mbti");
  const verbSel = document.getElementById("verbosity");
  const modeSel = document.getElementById("mode");

  const saved = JSON.parse(localStorage.getItem("mbtiSettings") || "{}");

  const state = {
    mbti: saved.mbti || "INTJ",
    verbosity: saved.verbosity || "normal",
    mode: saved.mode || "consult",
    history: [],
    threadId: null
  };

  // MBTIé¸æŠè‚¢
  MBTI_LIST.forEach(t => {
    const o = document.createElement("option");
    o.value = t;
    o.textContent = t;
    mbtiSel.appendChild(o);
  });

  // åˆæœŸå€¤åæ˜ 
  mbtiSel.value = state.mbti;
  verbSel.value = state.verbosity;
  modeSel.value = state.mode;

  function saveSettings() {
    localStorage.setItem("mbtiSettings", JSON.stringify({
      mbti: state.mbti,
      verbosity: state.verbosity,
      mode: state.mode
    }));
  }

  // â˜… StepLinkã®DMã‚¹ã‚¿ã‚¤ãƒ«ã«åˆã‚ã›ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸DOM
  function addMessage(text, who) {
    const d = document.createElement("div");
    d.className = `dm-message ${who === "me" ? "me" : "other"}`;
    d.textContent = text;
    chat.appendChild(d);
    chat.scrollTop = chat.scrollHeight;
  }

  function resetConversation(note) {
    state.history = [];
    state.threadId = null;
    if (note) addMessage(note, "other");
  }

  mbtiSel.onchange = () => {
    state.mbti = mbtiSel.value;
    saveSettings();
    resetConversation(`ï¼ˆMBTI: ${state.mbti} ã«å¤‰æ›´ï¼‰`);
  };

  verbSel.onchange = () => {
    state.verbosity = verbSel.value;
    saveSettings();
    resetConversation(`ï¼ˆæ–‡ç« é‡: ${state.verbosity} ã«å¤‰æ›´ï¼‰`);
  };

  modeSel.onchange = () => {
    state.mode = modeSel.value;
    saveSettings();
    resetConversation(`ï¼ˆãƒ¢ãƒ¼ãƒ‰: ${state.mode === "consult" ? "ç›¸è«‡" : "é›‘è«‡"} ã«å¤‰æ›´ï¼‰`);
  };

  newThreadBtn.onclick = () => resetConversation("ï¼ˆæ–°ã—ã„ä¼šè©±ã‚’é–‹å§‹ã—ã¾ã—ãŸï¼‰");
  clearBtn.onclick = () => { chat.innerHTML = ""; resetConversation("ï¼ˆè¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸï¼‰"); };

  function systemPrompt() {
    const len =
      state.verbosity === "short" ? "çŸ­ãè¦ç‚¹ã®ã¿ã€‚çµè«–â†’ç†ç”±ã®2æ®µã§ã€‚" :
      state.verbosity === "long"  ? "è©³ã—ãã€‚çµè«–â†’ç†ç”±â†’æ‰‹é †ï¼ˆå¿…è¦ãªã‚‰ä¾‹ï¼‰ã§ã€‚" :
      "èª­ã¿ã‚„ã™ã„æ¨™æº–çš„ãªé•·ã•ã€‚çµè«–â†’ç†ç”±â†’å¿…è¦ãªã‚‰æ‰‹é †ã€‚";

    const modeRule =
      state.mode === "consult"
        ? "ç›¸è«‡ãƒ¢ãƒ¼ãƒ‰ï¼šçŠ¶æ³æ•´ç†â†’ç¢ºèªè³ªå•ï¼ˆæœ€å¤§3ã¤ï¼‰â†’ææ¡ˆï¼ˆæœ€å¤§3ã¤ï¼‰ã€‚ç›¸æ‰‹ã‚’è¨ºæ–­ãƒ»æ–­å®šã—ãªã„ã€‚"
        : "é›‘è«‡ãƒ¢ãƒ¼ãƒ‰ï¼šãƒ†ãƒ³ãƒè‰¯ãä¼šè©±ã™ã‚‹ã€‚ãŸã ã—å¹¼å…èªãƒ»éå‰°ãªæ„Ÿå˜†ç¬¦ã¯ç¦æ­¢ã€‚å¿…è¦ãªã‚‰è³ªå•ã§åºƒã’ã‚‹ã€‚";

    return `
ã‚ãªãŸã¯StepLinkå†…ã®ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã€‚
é«˜æ ¡ç”Ÿä»¥ä¸Šå‘ã‘ã®æ–‡ä½“ã€‚å¹¼å…èªãƒ»æ“¬éŸ³ãƒ»éå‰°ãªæ„Ÿå˜†ç¬¦ã¯ç¦æ­¢ã€‚
äººã‚’è¨ºæ–­ãƒ»æ–­å®šã—ãªã„ã€‚å®‰å…¨ã«é…æ…®ã™ã‚‹ã€‚

è¿”ç­”ãƒ«ãƒ¼ãƒ«ï¼š${len}
ãƒ¢ãƒ¼ãƒ‰ï¼š${modeRule}

ã€MBTIãƒãƒªã‚·ãƒ¼ï¼ˆå¿…ãšéµå®ˆï¼‰ã€‘
${MBTI_POLICIES[state.mbti]}
`.trim();
  }

  async function requireUser() {
    const { data, error } = await supabase.auth.getUser();
    if (error || !data?.user) throw new Error("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
    return data.user;
  }

  async function ensureThread() {
    if (state.threadId) return state.threadId;

    const user = await requireUser();

    const { data: thread, error } = await supabase
      .from("ai_threads")
      .insert({
        user_id: user.id,
        title: "AI chat",
        mode: state.mode,
        mbti: state.mbti
      })
      .select()
      .single();

    if (error) throw error;

    state.threadId = thread.id;
    return state.threadId;
  }

  async function saveMessage(role, content) {
    const user = await requireUser();
    const threadId = await ensureThread();

    const { error } = await supabase
      .from("ai_messages")
      .insert({
        thread_id: threadId,
        user_id: user.id,
        role,
        content
      });

    if (error) throw error;
  }

  async function send() {
    const text = msg.value.trim();
    if (!text) return;

    msg.value = "";
    msg.focus();

    addMessage(text, "me");
    state.history.push({ role: "user", content: text });

    // userãƒ­ã‚°ä¿å­˜
    try { await saveMessage("user", text); }
    catch (e) { addMessage(`ï¼ˆãƒ­ã‚°ä¿å­˜å¤±æ•—ï¼š${e.message}ï¼‰`, "other"); }

    // thinking
    addMessage("â€¦è€ƒãˆä¸­", "other");
    const loading = chat.lastChild;

    try {
      const res = await fetch("https://ai.taisei-study928.workers.dev/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          system: systemPrompt(),
          messages: state.history.slice(-12)
        })
      });

      const data = await res.json();
      const reply = data.reply ?? "(è¿”ç­”ãŒç©ºã§ã—ãŸ)";

      loading.textContent = reply;
      state.history.push({ role: "assistant", content: reply });

      // assistantãƒ­ã‚°ä¿å­˜
      try { await saveMessage("assistant", reply); }
      catch (e) { addMessage(`ï¼ˆãƒ­ã‚°ä¿å­˜å¤±æ•—ï¼š${e.message}ï¼‰`, "other"); }

    } catch (e) {
      loading.textContent = "ã‚¨ãƒ©ãƒ¼ï¼š" + e.message;
    }
  }

  sendBtn.onclick = send;

  addMessage("StepLinkã‚¹ã‚¿ã‚¤ãƒ«ã§å‹•ä½œä¸­ã€‚ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã§è©±ã—ã‹ã‘ã¦ã­ã€‚", "other");
</script>

</body>
</html>
