<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>StepLink Chatbot</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      max-width: 820px;
      margin: 24px auto;
      padding: 0 14px;
      background: #fafafa;
    }
    h1 { margin-bottom: 8px; }
    #chat {
      border: 1px solid #ddd;
      border-radius: 14px;
      padding: 14px;
      height: 60vh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: #fff;
    }
    .msg {
      padding: 10px 14px;
      border-radius: 14px;
      white-space: pre-wrap;
      line-height: 1.5;
      max-width: 85%;
    }
    .me { align-self: flex-end; background: #e9e9e9; }
    .bot { align-self: flex-start; background: #ffffff; border: 1px solid #eee; }
    .row { display: flex; gap: 8px; margin-top: 12px; }
    button, select {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
    }
    textarea {
      flex: 1;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid #ddd;
      font-size: 15px;
      resize: vertical;
      min-height: 44px;
      max-height: 160px;
    }
  </style>
</head>
<body>

<h1>StepLink chatbot</h1>

<div class="row">
  <select id="mbti"></select>

  <select id="verbosity">
    <option value="short">短め</option>
    <option value="normal" selected>普通</option>
    <option value="long">詳しめ</option>
  </select>

  <select id="mode">
    <option value="consult" selected>相談</option>
    <option value="chat">雑談</option>
  </select>

  <button id="newThread">新しい会話</button>
</div>

<div id="chat"></div>

<div class="row">
  <textarea id="msg" placeholder="メッセージを入力…"></textarea>
  <button id="send">送信</button>
</div>

<script type="module">
  import { MBTI_LIST, MBTI_POLICIES } from "./mbti_policies.js";
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // ★ここを自分のに変更
  const SUPABASE_URL = "https://ngtthuwmqdcxgddlbsyo.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_YJzguO8nmmVKURa58cKwVw__9ulKxI6";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const chat = document.getElementById("chat");
  const msg = document.getElementById("msg");
  const sendBtn = document.getElementById("send");
  const newThreadBtn = document.getElementById("newThread");

  const mbtiSel = document.getElementById("mbti");
  const verbSel = document.getElementById("verbosity");
  const modeSel = document.getElementById("mode");

  const saved = JSON.parse(localStorage.getItem("mbtiSettings") || "{}");

  const state = {
    mbti: saved.mbti || "INTJ",
    verbosity: saved.verbosity || "normal",
    mode: saved.mode || "consult",
    history: [],
    threadId: null
  };

  // MBTI選択肢
  MBTI_LIST.forEach(t => {
    const o = document.createElement("option");
    o.value = t;
    o.textContent = t;
    mbtiSel.appendChild(o);
  });

  // 初期値反映
  mbtiSel.value = state.mbti;
  verbSel.value = state.verbosity;
  modeSel.value = state.mode;

  function saveSettings() {
    localStorage.setItem("mbtiSettings", JSON.stringify({
      mbti: state.mbti,
      verbosity: state.verbosity,
      mode: state.mode
    }));
  }

  function add(text, cls) {
    const d = document.createElement("div");
    d.className = "msg " + cls;
    d.textContent = text;
    chat.appendChild(d);
    chat.scrollTop = chat.scrollHeight;
  }

  function resetConversation(note) {
    state.history = [];
    state.threadId = null;
    if (note) add(note, "bot");
  }

  mbtiSel.onchange = () => {
    state.mbti = mbtiSel.value;
    saveSettings();
    resetConversation(`（MBTIスタイルを「${state.mbti}」に変更しました。新しい会話として扱います）`);
  };

  verbSel.onchange = () => {
    state.verbosity = verbSel.value;
    saveSettings();
    resetConversation(`（文章量を「${state.verbosity}」に変更しました。新しい会話として扱います）`);
  };

  modeSel.onchange = () => {
    state.mode = modeSel.value;
    saveSettings();
    resetConversation(`（モードを「${state.mode === "consult" ? "相談" : "雑談"}」に変更しました。新しい会話として扱います）`);
  };

  newThreadBtn.onclick = () => {
    resetConversation("（新しい会話を開始しました）");
  };

  function systemPrompt() {
    const len =
      state.verbosity === "short" ? "短く要点のみ。結論→理由の2段で。" :
      state.verbosity === "long"  ? "詳しく。結論→理由→手順（必要なら例）で。" :
      "読みやすい標準的な長さ。結論→理由→必要なら手順。";

    const modeRule =
      state.mode === "consult"
        ? "相談モード：状況整理→確認質問（最大3つ）→提案（最大3つ）。相手を診断・断定しない。"
        : "雑談モード：テンポ良く会話する。ただし幼児語・過剰な感嘆符は禁止。必要なら質問で広げる。";

    return `
あなたはStepLink内のチャットボット。
高校生以上向けの文体。幼児語・擬音・過剰な感嘆符は禁止。
人を診断・断定しない。安全に配慮する。

返答ルール：${len}
モード：${modeRule}

【MBTIポリシー（必ず遵守）】
${MBTI_POLICIES[state.mbti]}
`.trim();
  }

  async function requireUser() {
    const { data, error } = await supabase.auth.getUser();
    if (error || !data?.user) throw new Error("ログインが必要です");
    return data.user;
  }

  async function ensureThread() {
    if (state.threadId) return state.threadId;

    const user = await requireUser();

    const { data: thread, error } = await supabase
      .from("ai_threads")
      .insert({
        user_id: user.id,
        title: "AI chat",
        mode: state.mode,
        mbti: state.mbti
      })
      .select()
      .single();

    if (error) throw error;

    state.threadId = thread.id;
    return state.threadId;
  }

  async function saveMessage(role, content) {
    const user = await requireUser();
    const threadId = await ensureThread();

    const { error } = await supabase
      .from("ai_messages")
      .insert({
        thread_id: threadId,
        user_id: user.id,
        role,
        content
      });

    if (error) throw error;
  }

  async function send() {
    const text = msg.value.trim();
    if (!text) return;

    msg.value = "";
    msg.focus();

    add(text, "me");
    state.history.push({ role: "user", content: text });

    // ログ保存（ユーザー発言）
    try {
      await saveMessage("user", text);
    } catch (e) {
      add(`（ログ保存に失敗：${e.message}）`, "bot");
    }

    add("…考え中", "bot");
    const loading = chat.lastChild;

    try {
      const res = await fetch("https://ai.taisei-study928.workers.dev/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          system: systemPrompt(),
          messages: state.history.slice(-12)
        })
      });

      const data = await res.json();
      const reply = data.reply ?? "(返答が空でした)";
      loading.textContent = reply;

      state.history.push({ role: "assistant", content: reply });

      // ログ保存（AI返信）
      try {
        await saveMessage("assistant", reply);
      } catch (e) {
        add(`（ログ保存に失敗：${e.message}）`, "bot");
      }

    } catch (e) {
      loading.textContent = "エラー：" + e.message;
    }
  }

  sendBtn.onclick = send;

  add("ログイン済みの状態で話しかけてみて。会話ログはユーザーに紐づいて保存されます。", "bot");
</script>

</body>
</html>
